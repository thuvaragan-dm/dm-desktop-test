# .github/workflows/changesets-pr-master.yml
# (This is the version that should exist on your 'development' branch,
# ready to be merged into 'master' eventually)

name: Changesets Version PR - Master

on:
  push:
    branches:
      - master # Triggers only for the master branch

concurrency: changesets-pr-master-${{ github.ref }}

jobs:
  version-pr:
    if: github.repository == 'thuvaragan-dm/dm-desktop-test'
    timeout-minutes: 15
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Dependencies
        run: npm ci

      - name: Exit Pre-release Mode (if in pre-mode)
        run: |
          if [ -f ".changeset/pre.json" ]; then
            MODE=$(node -p "try { require('./.changeset/pre.json').mode } catch (e) { 'none' }")
            echo "Current pre-release mode detected on checked-out branch: $MODE"
            if [ "$MODE" != "exit" ]; then
              echo "Exiting pre-release mode..."
              npx changeset pre exit
              # Changes to .changeset/pre.json will be staged by 'npm run version-script'
            else
              echo "Branch already in 'exit' pre-release mode or pre.json is minimal."
            fi
          else
            echo "No .changeset/pre.json found. Assuming not in pre-release mode."
          fi
        shell: bash

      - name: Create or Update Production Version PR
        id: changesets-pr-master
        uses: changesets/action@v1
        with:
          version: npm run version-script # This is "changeset version && git add ."
          title: "chore: Upcoming Production Release Version Bump"
          commit: "chore: update production version and changelog via Changesets"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
